zizié£Ÿè°±-ä¸ªäººä¸»é¡µä¼˜åŒ–ç‰ˆ

<!DOCTYPE html>

    
    
    zizié£Ÿè°± - æ——èˆ°ç›²ç›’ç‰ˆ
    
    

    
        .hidden { display: none !important; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }

        .recipe-card { 
            position: relative; display: flex; gap: 16px; background: rgba(255,255,255,0.8); 
            backdrop-filter: blur(10px); padding: 20px; border-radius: 24px; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); margin-bottom: 16px; 
            border: 1px solid rgba(255,255,255,0.5); cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .recipe-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .recipe-thumb { width: 100px; height: 100px; border-radius: 16px; object-fit: cover; flex-shrink: 0; }

        .delete-btn { 
            position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.9); 
            width: 30px; height: 30px; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 14px; 
            color: #ff4d4f; border: 1px solid #eee; z-index: 20;
        }
        .delete-btn:hover { background: #ff4d4f; color: white; transform: scale(1.1); }

        /* ç‚¹èµæŒ‰é’®ä¸“å±ç‰¹æ•ˆ */
        .like-btn-active { animation: heart-burst 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes heart-burst {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }

        input, textarea, select { width: 100%; padding: 14px; border: 1px solid #eef2f6; border-radius: 16px; margin-bottom: 12px; outline: none; background: #f8fafc; transition: all 0.2s; }
        input:focus, textarea:focus { border-color: #10b981; background: white; box-shadow: 0 0 0 4px rgba(16,185,129,0.1); }

        .modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(6px); }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg) scale(1.1); }
            50% { transform: rotate(15deg) scale(1.1); }
            75% { transform: rotate(-15deg) scale(1.1); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out infinite; }
    





    
        
        
    

    
        
            ğŸ¥˜
            zizié£Ÿè°±
        
        åŒæ­¥çŠ¶æ€...
    

    
        ä»Šæ—¥æ¨è Recipes
        
        
            
        
        
    

    
        ç¾é£Ÿç¬é—´
        
    

    
        
            ğŸ¤” ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ
            é€‰æ‹©å›°éš¾ç—‡æ•‘æ˜Ÿï¼Œäº¤ç»™å‘½è¿æ¥å†³å®šå§ï¼
        

        ğŸ”®

        
            æ‘‡ä¸€æ‘‡ æŠ½å–
        

        
            
                
                âœ¨ å‘½è¿çš„æŒ‡å¼• âœ¨
                
            
        
    

    

    
        
        
            ğŸ‘¤
            æ¸¸å®¢å¨å¸ˆ
            ç™»å½•åå¼€å¯æ‚¨çš„ç§äººå¨æˆ¿
            ç™»å½• / æ³¨å†Œ
        

        

        
            
            
                
                    ğŸ‘¤
                    
                        å¨å¸ˆå¤§å¤§
                        user@rose.com
                        é€€å‡ºç™»å½•
                    
                
                
                
                    
                        0
                        æ€»å‘å¸ƒ
                    
                    
                        0
                        æ€»è·èµ
                    
                    
                        0
                        èœè°±æ•°
                    
                    
                        0
                        ç¬é—´æ•°
                    
                
            

            

            
                ğŸ¥˜ æˆ‘çš„èœè°±
                
            

            

            
                ğŸ“¸ æˆ‘çš„ç¬é—´
                
            
        
    

    
        ğŸ 
        ğŸ“¸
        
            +
        
        ğŸ²
        ğŸ‘¤
    

    
        
            æ¬¢è¿å›æ¥
            
            
            ç¡®è®¤
            åˆ‡æ¢ç™»å½•/æ³¨å†Œ
            å–æ¶ˆ
        
    

    
        
            åˆ†äº«æ–°é²œäº‹
            
                ğŸ¥˜ å‘å¸ƒåˆ°èœè°±åŒº
                ğŸ“¸ å‘å¸ƒåˆ°ç¬é—´åŒº
            
            
            
            
                
            
            
                å–æ¶ˆ
                ç«‹å³å‘å¸ƒ
            
        
    

    
        
            
                
                
                
            
            
                
                
                æ”¶èµ·è¯¦æƒ…
            
        
    

    
        const CONF = {
            url: "https://kmsbrisiajtykflnskpj.supabase.co",
            key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imttc2JyaXNpYWp0eWtmbG5za3BqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODM2NzIsImV4cCI6MjA4NzY1OTY3Mn0.e8-qaJpmrGVc_GcWVEBHEUHWWiJ40Ax5BMyWTZsGqbE"
        };
        const _client = supabase.createClient(CONF.url, CONF.key);
        let currentUser = null, isSignUp = false, allData = [], searchTerm = '';

        // ç™»å½•çŠ¶æ€ç›‘å¬
        \client.auth.onAuthStateChange((\, session) => {
            currentUser = session?.user || null;
            updateUI();
            fetchData();
        });

        // æ‹‰å–å…¨é‡æ•°æ®
        async function fetchData() {
            const { data, error } = await _client.from('recipes').select('*').order('created_at', { ascending: false });
            if (error) { console.error(error); return; }
            allData = data || [];
            renderContent();
            renderProfile(); // æ•°æ®æ›´æ–°æ—¶åŒæ­¥åˆ·æ–°ä¸ªäººä¸»é¡µ
        }

        // æ¸²æŸ“é¦–é¡µ/ç¬é—´é¡µå†…å®¹
        function renderContent() {
            // æ¸²æŸ“èœè°±åŒº + æ¨¡ç³Šæœç´¢è¿‡æ»¤
            const recipes = allData.filter(i => {
                if (i.type && i.type !== 'recipe') return false;
                if (!searchTerm) return true;
                const titleMatch = i.title.toLowerCase().includes(searchTerm);
                const notesMatch = i.notes && i.notes.toLowerCase().includes(searchTerm);
                const authorMatch = i.author && i.author.toLowerCase().includes(searchTerm);
                return titleMatch || notesMatch || authorMatch;
            });
            
            document.getElementById('recipe-list').innerHTML = recipes.map(i => {
                const likesArr = Array.isArray(i.likes) ? i.likes : (i.likes ? JSON.parse(i.likes) : []);
                const isLiked = currentUser && likesArr.includes([currentUser.id](currentUser.id));
                return `
                <div class="recipe-card" onclick="showDetail('${[i.id](i.id)}')">
                    \$${(currentUser && i.created_by === currentUser.id) ? `<div class="delete-btn" onclick="handleDelete(event, '\$${[i.id](i.id)}')">ğŸ—‘ï¸</div>` : ''}
                    <div class="flex-1 min-w-0 flex flex-col justify-between">
                        <div>
                            <h3 class="font-black text-lg mb-1 truncate text-slate-800">${i.title}</h3>
                            <p class="text-xs text-slate-400 line-clamp-2">${i.notes || 'è¿™å®¶ä¼™å¾ˆæ‡’ï¼Œæ²¡å†™å¿ƒå¾—'}</p>
                        </div>
                        <div class="flex items-center justify-between mt-3">
                            <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-wider">BY @${i.author || 'åŒ¿å'}</p>
                            <button class="flex items-center gap-1.5 z-20 px-2 py-1 rounded-full hover:bg-slate-50 transition-colors \$${isLiked ? 'text-red-500' : 'text-slate-300'}" onclick="handleLike(event, '\$${[i.id](i.id)}')">
                                <span class="text-sm \$${isLiked ? 'like-btn-active' : ''}">\$${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                                <span class="text-xs font-bold">${likesArr.length > 0 ? likesArr.length : 'èµ'}</span>
                            </button>
                        </div>
                    </div>
                    <img src="${i.image_url}" class="recipe-thumb bg-slate-50 shadow-inner">
                </div>
            `}).join('') || (searchTerm ? 
                '<div class="text-center py-20 text-slate-300 italic">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³èœè°±ï¼Œæ¢ä¸ªå…³é”®è¯è¯•è¯•å§</div>' :
                '<div class="text-center py-20 text-slate-300 italic">ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å‘å¸ƒå§</div>');

            // æ¸²æŸ“ç¬é—´åŒº
            const moments = allData.filter(i => i.type === 'moment');
            document.getElementById('moment-grid').innerHTML = moments.map(i => {
                const likesArr = Array.isArray(i.likes) ? i.likes : (i.likes ? JSON.parse(i.likes) : []);
                const isLiked = currentUser && likesArr.includes([currentUser.id](currentUser.id));
                return `
                <div class="relative rounded-[24px] overflow-hidden aspect-[3/4] bg-slate-100 shadow-md group" onclick="showDetail('${[i.id](i.id)}')">
                    \$${(currentUser && i.created_by === currentUser.id) ? `<div class="delete-btn" onclick="handleDelete(event, '\$${[i.id](i.id)}')">ğŸ—‘ï¸</div>` : ''}
                    <img src="${i.image_url}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                    <div class="absolute inset-x-0 bottom-0 p-4 bg-gradient-to-t from-black/60 to-transparent flex justify-between items-end">
                        <p class="text-white text-[10px] font-bold">@${i.author}</p>
                        <button class="flex items-center gap-1 z-20 \$${isLiked ? 'text-red-500' : 'text-white'}" onclick="handleLike(event, '\$${[i.id](i.id)}')">
                            <span class="text-sm drop-shadow-md \$${isLiked ? 'like-btn-active' : ''}">\$${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                            <span class="text-xs font-bold drop-shadow-md">${likesArr.length > 0 ? likesArr.length : ''}</span>
                        </button>
                    </div>
                </div>
            `}).join('') || '<div class="col-span-2 text-center py-20 text-slate-300 italic">æš‚æ— ç¾å›¾</div>';
        }

        // æ–°å¢ï¼šæ¸²æŸ“ä¸ªäººä¸»é¡µå†…å®¹
        function renderProfile() {
            if (!currentUser) return;

            // è¿‡æ»¤å½“å‰ç”¨æˆ·å‘å¸ƒçš„æ‰€æœ‰å†…å®¹
            const myAllPosts = allData.filter(i => i.created_by === [currentUser.id](currentUser.id));
            const myRecipes = myAllPosts.filter(i => !i.type || i.type === 'recipe');
            const myMoments = myAllPosts.filter(i => i.type === 'moment');
            
            // è®¡ç®—æ€»è·èµæ•°
            const totalLikes = myAllPosts.reduce((sum, item) => {
                const likesArr = Array.isArray(item.likes) ? item.likes : (item.likes ? JSON.parse(item.likes) : []);
                return sum + likesArr.length;
            }, 0);

            // å¡«å……ç»Ÿè®¡æ•°æ®
            document.getElementById('stat-total-posts').innerText = myAllPosts.length;
            document.getElementById('stat-total-likes').innerText = totalLikes;
            document.getElementById('stat-recipes').innerText = myRecipes.length;
            document.getElementById('stat-moments').innerText = myMoments.length;

            // æ¸²æŸ“æˆ‘çš„èœè°±åˆ—è¡¨
            document.getElementById('my-recipe-list').innerHTML = myRecipes.map(i => {
                const likesArr = Array.isArray(i.likes) ? i.likes : (i.likes ? JSON.parse(i.likes) : []);
                const isLiked = currentUser && likesArr.includes([currentUser.id](currentUser.id));
                return `
                <div class="recipe-card" onclick="showDetail('${[i.id](i.id)}')">
                    <div class="delete-btn" onclick="handleDelete(event, '${[i.id](i.id)}')">ğŸ—‘ï¸</div>
                    <div class="flex-1 min-w-0 flex flex-col justify-between">
                        <div>
                            <h3 class="font-black text-lg mb-1 truncate text-slate-800">${i.title}</h3>
                            <p class="text-xs text-slate-400 line-clamp-2">${i.notes || 'è¿™å®¶ä¼™å¾ˆæ‡’ï¼Œæ²¡å†™å¿ƒå¾—'}</p>
                        </div>
                        <div class="flex items-center justify-between mt-3">
                            <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-wider">BY @${i.author || 'åŒ¿å'}</p>
                            <button class="flex items-center gap-1.5 z-20 px-2 py-1 rounded-full hover:bg-slate-50 transition-colors \$${isLiked ? 'text-red-500' : 'text-slate-300'}" onclick="handleLike(event, '\$${[i.id](i.id)}')">
                                <span class="text-sm \$${isLiked ? 'like-btn-active' : ''}">\$${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                                <span class="text-xs font-bold">${likesArr.length > 0 ? likesArr.length : 'èµ'}</span>
                            </button>
                        </div>
                    </div>
                    <img src="${i.image_url}" class="recipe-thumb bg-slate-50 shadow-inner">
                </div>
                `;
            }).join('') || '<div class="text-center py-10 text-slate-300 italic">ä½ è¿˜æ²¡æœ‰å‘å¸ƒè¿‡èœè°±ï¼Œå¿«å»åˆ†äº«ä½ çš„ç¾é£Ÿå§</div>';

            // æ¸²æŸ“æˆ‘çš„ç¬é—´ç½‘æ ¼
            document.getElementById('my-moment-grid').innerHTML = myMoments.map(i => {
                const likesArr = Array.isArray(i.likes) ? i.likes : (i.likes ? JSON.parse(i.likes) : []);
                const isLiked = currentUser && likesArr.includes([currentUser.id](currentUser.id));
                return `
                <div class="relative rounded-[24px] overflow-hidden aspect-[3/4] bg-slate-100 shadow-md group" onclick="showDetail('${[i.id](i.id)}')">
                    <div class="delete-btn" onclick="handleDelete(event, '${[i.id](i.id)}')">ğŸ—‘ï¸</div>
                    <img src="${i.image_url}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                    <div class="absolute inset-x-0 bottom-0 p-4 bg-gradient-to-t from-black/60 to-transparent flex justify-between items-end">
                        <p class="text-white text-[10px] font-bold">@${i.author}</p>
                        <button class="flex items-center gap-1 z-20 \$${isLiked ? 'text-red-500' : 'text-white'}" onclick="handleLike(event, '\$${[i.id](i.id)}')">
                            <span class="text-sm drop-shadow-md \$${isLiked ? 'like-btn-active' : ''}">\$${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                            <span class="text-xs font-bold drop-shadow-md">${likesArr.length > 0 ? likesArr.length : ''}</span>
                        </button>
                    </div>
                </div>
                `;
            }).join('') || '<div class="col-span-2 text-center py-10 text-slate-300 italic">ä½ è¿˜æ²¡æœ‰å‘å¸ƒè¿‡ç¬é—´ï¼Œå¿«å»è®°å½•ä½ çš„ç¾é£Ÿæ—¥å¸¸å§</div>';
        }

        // ç‚¹èµé€»è¾‘
        async function handleLike(e, id) {
            e.stopPropagation();
            if (!currentUser) {
                console.log("ç‚¹èµå¤±è´¥ï¼šç”¨æˆ·æœªç™»å½•");
                return showModal('modal-auth');
            }
            console.log("å½“å‰ç”¨æˆ·ID:", [currentUser.id](currentUser.id));

            const item = allData.find(i => [i.id](i.id) == id);
            if (!item) {
                console.log("ç‚¹èµå¤±è´¥ï¼šæœªæ‰¾åˆ°IDä¸º", id, "çš„æ¡ç›®ï¼Œå½“å‰æ‰€æœ‰æ¡ç›®ID:", allData.map(i => [i.id](i.id)));
                return alert("æœªæ‰¾åˆ°è¯¥èœè°±");
            }
            console.log("æ‰¾åˆ°çš„èœè°±æ¡ç›®:", item);

            let currentLikes;
            try {
                if (Array.isArray(item.likes)) {
                    currentLikes = [...item.likes];
                } else if (item.likes && typeof item.likes === 'string') {
                    currentLikes = JSON.parse(item.likes);
                    if (!Array.isArray(currentLikes)) currentLikes = [];
                } else {
                    currentLikes = [];
                }
            } catch (err) {
                console.log("è§£æç‚¹èµæ•°æ®å‡ºé”™:", err);
                currentLikes = [];
            }
            console.log("å½“å‰ç‚¹èµæ•°ç»„:", currentLikes);

            const hasLiked = currentLikes.includes([currentUser.id](currentUser.id));
            console.log("ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ:", hasLiked);

            if (hasLiked) {
                currentLikes = currentLikes.filter(userId => userId !== [currentUser.id](currentUser.id));
            } else {
                currentLikes.push([currentUser.id](currentUser.id));
            }
            console.log("æ›´æ–°åçš„ç‚¹èµæ•°ç»„:", currentLikes);

            // å‰ç«¯å³æ—¶æ›´æ–°UI
            item.likes = currentLikes;
            renderContent();
            renderProfile(); // ç‚¹èµååŒæ­¥æ›´æ–°ä¸ªäººä¸»é¡µçš„ç»Ÿè®¡æ•°æ®

            // åŒæ­¥åˆ°æ•°æ®åº“
            try {
                const { data, error } = await _client.from('recipes')
                    .update({ likes: JSON.stringify(currentLikes) })
                    .eq('id', id)
                    .select();
                if (error) {
                    console.log("æ•°æ®åº“æ›´æ–°é”™è¯¯è¯¦æƒ…:", error);
                    throw error;
                }
                console.log("æ•°æ®åº“æ›´æ–°æˆåŠŸï¼Œè¿”å›æ•°æ®:", data);
            } catch (err) {
                console.error("ç‚¹èµåŒæ­¥å¤±è´¥è¯¦æƒ…:", err);
                alert("ç‚¹èµåŒæ­¥å¤±è´¥: " + err.message);
                fetchData();
            }
        }

        // æŠ½ç­¾é€»è¾‘
        function startDraw() {
            const recipes = allData.filter(i => !i.type || i.type === 'recipe');
            if (recipes.length === 0) return alert("èœè°±åº“é‡Œè¿˜æ²¡æœ‰å¥½åƒçš„ï¼Œå…ˆå»å‘å‡ ä¸ªå§ï¼");

            const box = document.getElementById('lucky-box');
            const resultDiv = document.getElementById('lucky-result');
            
            resultDiv.classList.add('hidden', 'opacity-0');
            box.classList.add('animate-shake');
            box.innerText = "ğŸ²";

            setTimeout(() => {
                box.classList.remove('animate-shake');
                box.innerText = "ğŸ”®";
                
                const randomItem = recipes[Math.floor(Math.random() * recipes.length)];
                
                document.getElementById('lucky-card-container').innerHTML = `
                    <div class="flex gap-4 cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition-colors" onclick="showDetail('${[randomItem.id](randomItem.id)}')">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-black text-lg mb-1 truncate text-slate-800">${randomItem.title}</h3>
                            <p class="text-xs text-slate-400 line-clamp-2">${randomItem.notes || 'ç¾å‘³è®°å½•...'}</p>
                            <p class="text-[10px] text-emerald-500 mt-2 font-bold uppercase">@${randomItem.author || 'åŒ¿å'}</p>
                        </div>
                        <img src="${randomItem.image_url}" class="w-20 h-20 rounded-xl object-cover bg-slate-50 flex-shrink-0">
                    </div>
                `;
                
                resultDiv.classList.remove('hidden');
                setTimeout(() => resultDiv.classList.remove('opacity-0'), 50);

            }, 800);
        }

        // å‘å¸ƒé€»è¾‘
        async function handlePost() {
            const t = document.getElementById('post-title').value.trim();
            const f = document.getElementById('post-file').files[0];
            const type = document.getElementById('post-type').value;
            const n = document.getElementById('post-notes').value.trim();

            if (!t || !f) return alert("æ ‡é¢˜å’Œç…§ç‰‡å¿…å¡«å“¦ï¼");
            const btn = document.getElementById('post-submit');
            btn.innerText = "é£å¾€äº‘ç«¯..."; btn.disabled = true;

            try {
                const ext = f.name.split('.').pop();
                const path = \public/${Date.now()}_${Math.random().toString(36).slice(-4)}.${ext}\;
                const { error: upErr } = await _client.storage.from('recipe-images').upload(path, f);
                if (upErr) throw upErr;

                const { data: urlObj } = _client.storage.from('recipe-images').getPublicUrl(path);
                
                const postData = {
                    title: t, notes: n, type: type,
                    image_url: urlObj.publicUrl,
                    author: currentUser.email.split('@')[0],
                    created_by: [currentUser.id](currentUser.id),
                    likes: []
                };

                const { error: dbErr } = await _client.from('recipes').insert([postData]);
                if (dbErr) throw dbErr;

                hideModal('modal-post');
                fetchData();
                alert("å‘å¸ƒæˆåŠŸï¼âœ¨");
            } catch (e) { alert("å‘å¸ƒå¤±è´¥: " + e.message); }
            finally { btn.innerText = "ç«‹å³å‘å¸ƒ"; btn.disabled = false; }
        }

        // åˆ é™¤é€»è¾‘
        async function handleDelete(e, id) {
            e.stopPropagation();
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿ")) return;
            try {
                const { error } = await _client.from('recipes').delete().eq('id', id);
                if (error) throw error;
                fetchData();
            } catch (err) { alert("åˆ é™¤å¤±è´¥: " + err.message); }
        }

        // è¯¦æƒ…å¼¹çª—
        window.showDetail = (id) => {
            const item = allData.find(i => [i.id](i.id) == id);
            if (!item) return;
            document.getElementById('detail-img').src = item.image_url;
            document.getElementById('detail-title').innerText = item.title;
            document.getElementById('detail-notes').innerText = item.notes || 'ç¾å‘³è®°å½•...';
            document.getElementById('detail-author').innerText = 'Cooked by @' + (item.author || 'åŒ¿å');
            showModal('modal-detail');
        };

        // UIçŠ¶æ€æ›´æ–°
        function updateUI() {
            const hBtn = document.getElementById('header-auth-btn');
            const profileGuest = document.getElementById('profile-guest');
            const profileLogged = document.getElementById('profile-logged');
            const pAvatarGuest = document.getElementById('p-avatar-guest');
            const pAvatarLogged = document.getElementById('p-avatar-logged');
            const pNameLogged = document.getElementById('p-name-logged');
            const pEmailLogged = document.getElementById('p-email-logged');
            const pActionBtnGuest = document.getElementById('p-action-btn-guest');
            const pActionBtnLogged = document.getElementById('p-action-btn-logged');

            if (currentUser) {
                const name = currentUser.email.split('@')[0];
                // é¡¶éƒ¨header
                hBtn.innerText = \é€€å‡º (${name})\; 
                hBtn.onclick = () => _client.auth.signOut();
                // ä¸ªäººä¸»é¡µå·²ç™»å½•çŠ¶æ€
                profileGuest.classList.add('hidden');
                profileLogged.classList.remove('hidden');
                pAvatarLogged.innerText = name[0].toUpperCase();
                pNameLogged.innerText = name;
                pEmailLogged.innerText = currentUser.email;
                pActionBtnLogged.onclick = () => _client.auth.signOut();
                renderProfile();
            } else {
                // æœªç™»å½•çŠ¶æ€
                hBtn.innerText = "ç™»å½•/æ³¨å†Œ"; 
                hBtn.onclick = () => showModal('modal-auth');
                profileGuest.classList.remove('hidden');
                profileLogged.classList.add('hidden');
                pAvatarGuest.innerText = "ğŸ‘¤";
                pActionBtnGuest.onclick = () => showModal('modal-auth');
            }
        }

        // ç™»å½•/æ³¨å†Œé€»è¾‘
        async function handleAuth() {
            const u = document.getElementById('auth-user').value.trim();
            const p = document.getElementById('auth-pwd').value.trim();
            if (!u || p.length < 6) return alert("åå­—å¿…å¡«ï¼Œå¯†ç è‡³å°‘6ä½");
            const email = \${encodeURIComponent(u)}@rose.com\;
            try {
                const { error } = isSignUp ? await _client.auth.signUp({ email, password: p }) : await _client.auth.signInWithPassword({ email, password: p });
                if (error) throw error;
                hideModal('modal-auth');
            } catch (e) { alert("éªŒè¯å¤±è´¥: " + e.message); }
        }

        // è§†å›¾åˆ‡æ¢
        function switchView(v) { 
            ['view-home', 'view-moment', 'view-lucky', 'view-profile'].forEach(id => 
                document.getElementById(id).classList.toggle('hidden', id !== \view-${v}\)
            );
            // åˆ‡æ¢åˆ°ä¸ªäººä¸»é¡µæ—¶åˆ·æ–°å†…å®¹
            if (v === 'profile') renderProfile();
        }
        function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function hideModal(id) { document.getElementById(id).classList.add('hidden'); }

        // å¯¼èˆªäº‹ä»¶ç»‘å®š
        document.getElementById('nav-home').onclick = () => switchView('home');
        document.getElementById('nav-moment').onclick = () => switchView('moment');
        document.getElementById('nav-lucky').onclick = () => switchView('lucky');
        document.getElementById('nav-profile').onclick = () => switchView('profile');
        document.getElementById('nav-post').onclick = () => currentUser ? showModal('modal-post') : showModal('modal-auth');
        document.getElementById('auth-submit').onclick = handleAuth;
        document.getElementById('post-submit').onclick = handlePost;
        document.getElementById('auth-toggle').onclick = () => {
            isSignUp = !isSignUp;
            document.getElementById('auth-title').innerText = isSignUp ? "åŠ å…¥æˆ‘ä»¬" : "æ¬¢è¿å›æ¥";
        };

        // æœç´¢äº‹ä»¶ç»‘å®š
        document.getElementById('search-input').addEventListener('input', (e) => {
            searchTerm = e.target.value.trim().toLowerCase();
            renderContent();
        });
    


