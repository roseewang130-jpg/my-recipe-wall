<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç¤¾äº¤é£Ÿè°±å¢™</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #00695c; --bg: #f4f7f6; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 70px; }
        header { background: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 20px; flex-grow: 1; justify-content: center; }
        .tab { cursor: pointer; padding: 5px 10px; color: #666; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        #content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; padding: 10px; }
        .card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 160px; object-fit: cover; background: #eee; }
        .card-info { padding: 8px; }
        .card-title { font-size: 14px; font-weight: bold; margin-bottom: 4px; }
        .card-author { font-size: 11px; color: #999; }
        .fab { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; border: none; border-radius: 50px; padding: 12px 25px; font-size: 16px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 99; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; }
        input, textarea, select { width: 100%; margin: 8px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-main { background: var(--primary); color: white; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; color: var(--primary);">ğŸ¥£ ç¤¾äº¤é£Ÿè°±</div>
    <div class="tabs">
        <div class="tab active" id="tab-recipe" onclick="switchTab('recipe')">é£Ÿè°±</div>
        <div class="tab" id="tab-moment" onclick="switchTab('moment')">ç¬é—´</div>
    </div>
    <div id="user-status" style="font-size: 12px; color: #666; cursor: pointer;" onclick="openAuth()">æœªç™»å½•</div>
</header>

<div id="content-grid"></div>

<button class="fab" onclick="openPost()">+ åˆ†äº«ç¾é£Ÿ</button>

<div id="auth-modal" class="modal">
    <div class="modal-content">
        <h3 id="auth-title">æ–°å¨å¸ˆæ³¨å†Œ</h3>
        <input type="text" id="auth-user" placeholder="è¾“å…¥æ˜µç§° (å¦‚: å°å–µå–µ)">
        <input type="password" id="auth-pwd" placeholder="è®¾ç½®å¯†ç ">
        <div class="btn-group">
            <button class="btn-main" id="auth-btn" onclick="handleAuth()">ç¡®å®š</button>
            <button onclick="closeAuth()">å–æ¶ˆ</button>
        </div>
        <p style="font-size: 12px; text-align: center; margin-top: 10px;">
            <a href="javascript:void(0)" onclick="toggleAuthMode()" id="auth-toggle-text" style="color: var(--primary)">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</a>
        </p>
    </div>
</div>

<div id="post-modal" class="modal">
    <div class="modal-content">
        <h3>åˆ†äº«ä½ çš„ç¾å‘³</h3>
        <select id="post-type">
            <option value="recipe">å‘å¸ƒåˆ° [é£Ÿè°±]</option>
            <option value="moment">å‘å¸ƒåˆ° [ç¬é—´]</option>
        </select>
        <input type="text" id="in-title" placeholder="ç»™ç¾å‘³èµ·ä¸ªåå­—">
        <textarea id="in-notes" placeholder="åˆ†äº«ä¸€ä¸‹å¿ƒå¾—å§..." rows="3"></textarea>
        <input type="file" id="in-file" accept="image/*">
        <div class="btn-group">
            <button class="btn-main" id="pub-btn" onclick="handlePublish()">ç«‹å³å‘å¸ƒ</button>
            <button onclick="closePost()">è¿”å›</button>
        </div>
    </div>
</div>

<script>
    // --- é…ç½®åŒº ---
    // URL æ ¹æ® image_293a36.png å¡«å…¥
    const SB_URL = "https://kmsbrisiajtykflnskpj.supabase.co"; 
    
    // [!!!å…³é”®!!!] è¿™é‡Œçš„ Key ä¾ç„¶æ˜¯å¸¦çœç•¥å·çš„ï¼Œè¯·æ‰‹åŠ¨å» Supabase é¡µé¢
    // ç‚¹å‡»ä½ åœ¨ image_29363a.png ä¸­ç”»çº¢ç®­å¤´æŒ‡ç€çš„é‚£ä¸ªâ€œå¤åˆ¶â€å›¾æ ‡ï¼Œç„¶åç²˜è´´åˆ°è¿™é‡Œ
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imttc2JyaXNpYWp0eWtmbG5za3BqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODM2NzIsImV4cCI6MjA4NzY1OTY3Mn0.e8-qaJpmrGVc_GcWVEBHEUHWWiJ40Ax5BMyWTZsGqbE"; 

    const _client = supabase.createClient(SB_URL, SB_KEY);

    let currentUser = null;
    let isSignUp = true;
    let currentView = 'recipe';

    // ä¿®å¤ï¼šå¤„ç†ä¸­æ–‡åæ³¨å†ŒæŠ¥é”™
    async function handleAuth() {
        const user = document.getElementById('auth-user').value.trim();
        const pwd = document.getElementById('auth-pwd').value.trim();
        if (user.length < 2) return alert("åå­—å¤ªçŸ­å•¦");

        // å°†ä¸­æ–‡è½¬ä¸ºå®‰å…¨é‚®ç®±æ ¼å¼
        const safeEmail = btoa(encodeURIComponent(user)).replace(/=/g, '').toLowerCase() + "@rose.com";

        try {
            if (isSignUp) {
                const { error } = await _client.auth.signUp({ 
                    email: safeEmail, 
                    password: pwd, 
                    options: { data: { display_name: user } } 
                });
                if (error) throw error;
                alert("æ³¨å†ŒæˆåŠŸï¼è¯·åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼è¿›å…¥");
                toggleAuthMode();
            } else {
                const { error, data } = await _client.auth.signInWithPassword({ email: safeEmail, password: pwd });
                if (error) throw new Error("åå­—æˆ–å¯†ç ä¸å¯¹å“¦");
                currentUser = data.user;
                document.getElementById('user-status').innerText = `å·²ç™»å½•: ${user}`;
                closeAuth();
                fetchData();
            }
        } catch (e) { alert("æ“ä½œå¤±è´¥: " + e.message); }
    }

    // ä¿®å¤ï¼šå¤„ç†å›¾ç‰‡è·¯å¾„åŒ…å«ä¸­æ–‡å¯¼è‡´çš„ Invalid Key æŠ¥é”™
    async function handlePublish() {
        if (!currentUser) return openAuth();
        const title = document.getElementById('in-title').value.trim();
        const notes = document.getElementById('in-notes').value.trim();
        const type = document.getElementById('post-type').value;
        const file = document.getElementById('in-file').files[0];
        const btn = document.getElementById('pub-btn');

        if (!title || !file) return alert("æ ‡é¢˜å’Œç…§ç‰‡éƒ½ä¸èƒ½å°‘å“¦");

        btn.disabled = true; btn.innerText = "æ­£åœ¨é£å¾€äº‘ç«¯...";

        try {
            // å°†æ–‡ä»¶åè§„èŒƒåŒ–ä¸ºæ—¶é—´æˆ³ï¼Œè§£å†³è·¯å¾„éæ³•é—®é¢˜
            const fileExt = file.name.split('.').pop();
            const filePath = `public/${Date.now()}.${fileExt}`;

            const { error: upErr } = await _client.storage.from('recipe-images').upload(filePath, file);
            if (upErr) throw upErr;

            const { data: urlData } = _client.storage.from('recipe-images').getPublicUrl(filePath);
            
            const { error: dbErr } = await _client.from('recipes').insert([{
                title, notes, image_url: urlData.publicUrl, type,
                author: currentUser.user_metadata.display_name || "ç¥ç§˜å¨å¸ˆ",
                created_by: currentUser.id
            }]);

            if (dbErr) throw dbErr;
            alert("å¤§åŠŸå‘Šæˆï¼å·²åŒæ­¥åˆ°åˆ†äº«åŒº");
            closePost();
            fetchData();
        } catch (e) { alert("å‘å¸ƒå¤±è´¥: " + e.message); }
        finally { btn.disabled = false; btn.innerText = "ç«‹å³å‘å¸ƒ"; }
    }

    async function fetchData() {
        const grid = document.getElementById('content-grid');
        grid.innerHTML = "<p style='text-align:center;color:#999;'>æ­£åœ¨åŠ è½½...</p>";
        try {
            const { data, error } = await _client.from('recipes')
                .select('*')
                .eq('type', currentView)
                .order('created_at', { ascending: false });
            if (error) throw error;
            grid.innerHTML = data.length ? "" : "<p style='text-align:center;padding-top:50px;color:#999;'>ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å‘å¸ƒå§ï¼</p>";
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<img src="${item.image_url}"><div class="card-info"><div class="card-title">${item.title}</div><div class="card-author">By ${item.author}</div></div>`;
                grid.appendChild(card);
            });
        } catch (e) { grid.innerHTML = "æ•°æ®åŒæ­¥æš‚æ—¶ç¦»çº¿ï¼Œè¯·æ£€æŸ¥ API é…ç½®"; }
    }

    function switchTab(view) {
        currentView = view;
        document.getElementById('tab-recipe').classList.toggle('active', view === 'recipe');
        document.getElementById('tab-moment').classList.toggle('active', view === 'moment');
        fetchData();
    }

    function openAuth() { document.getElementById('auth-modal').style.display = 'flex'; }
    function closeAuth() { document.getElementById('auth-modal').style.display = 'none'; }
    function toggleAuthMode() {
        isSignUp = !isSignUp;
        document.getElementById('auth-title').innerText = isSignUp ? "æ–°å¨å¸ˆæ³¨å†Œ" : "æ¬¢è¿å›æ¥";
        document.getElementById('auth-toggle-text').innerText = isSignUp ? "å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•" : "æ²¡è´¦å·ï¼Ÿå»æ³¨å†Œ";
    }
    function openPost() { if(!currentUser) return openAuth(); document.getElementById('post-modal').style.display = 'flex'; }
    function closePost() { document.getElementById('post-modal').style.display = 'none'; }

    fetchData();
</script>
</body>
</html>
